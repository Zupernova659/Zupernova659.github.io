### **一、概述**

**1、I2C总线只有两根双向信号线。一根是数据线SDA，另一根是时钟线SCL。**

SCL：上升沿将数据输入到每个EEPROM器件中；下降沿驱动EEPROM器件输出数据。（边沿触发）

SDA：双向数据线，为OD门，与其它任意数量的OD与OC门成\线与\关系。

I2C总线通过上拉电阻接正电源。当总线空闲时，两根线均为高电平（SDL=1;SCL=1）。连到总线上的任一器件输出的低电平，都将使总线的信号变低，即各器件的SDA及SCL都是线“与”关系。

**2、主设备与从设备**

系统中的所有外围器件都具有一个7位的从器件专用地址码，其中高4位为器件类型，由生产厂家制定，低3位为器件引脚定义地址，由使用者定义。

主控器件通过地址码建立多机通信的机制，因此I2C总线省去了外围器件的片选线，这样无论总线上挂接多少个器件，其系统仍然为简约的二线结构。

终端挂载在总线上，有主端和从端之分，主端必须是带有CPU的逻辑模块，在同一总线上同一时刻使能有一个主端，可以有多个从端，从端的数量受地址空间和总线的最大电容 400pF的限制。

主端主要用来驱动SCL line； 从设备对主设备产生响应；

二者都可以传输数据，但是从设备不能发起传输，且传输是受到主设备控制的。

### **二、协议**

**1.空闲状态**

I2C总线总线的SDA和SCL两条信号线同时处于高电平时，规定为总线的空闲状态。

此时各个器件的输出级场效应管均处在截止状态，即释放总线，由两条信号线各自的上拉电阻把电平拉高。

**2.起始位与停止位的定义**

起始信号：当SCL为高期间，SDA由高到低的跳变；启动信号是一种电平跳变时序信号，而不是一个电平信号。

停止信号：当SCL为高期间，SDA由低到高的跳变；停止信号也是一种电平跳变时序信号，而不是一个电平信号。

![img](https://img2020.cnblogs.com/blog/1943620/202111/1943620-20211119154508611-1283932793.png)

起始和终止信号都是由主机发出的，在起始信号产生后，总线就处于被占用的状态；在终止信号产生后，总线就处于空闲状态。

接收器件收到一个完整的数据字节后，有可能需要完成一些其它工作，如处理内部中断服务等，可能无法立刻接收下一个字节，这时接收器件可以将SCL线拉成低电平，从而使主机处于等待状态。

直到接收器件准备好接收下一个字节时，再释放SCL线使之为高电平，从而使数据传送可以继续进行。

**3.ACK**

发送器每发送一个字节，就在时钟脉冲9期间释放数据线，由接收器反馈一个应答信号。

应答信号为低电平时，规定为有效应答位（ACK简称应答位），表示接收器已经成功地接收了该字节；应答信号为高电平时，规定为非应答位（NACK），一般表示接收器接收该字节没有成功。

对于反馈有效应答位ACK的要求是，接收器在第9个时钟脉冲之前的低电平期间将SDA线拉低，并且确保在该时钟的高电平期间为稳定的低电平。

如果接收器是主控器，则在它收到最后一个字节后，发送一个NACK信号，以通知被控发送器结束数据发送，并释放SDA线，以便主控接收器发送一个停止信号P。

**4.数据的有效性：**

I2C总线进行数据传送时，时钟信号为高电平期间，数据线上的数据必须保持稳定，只有在时钟线上的信号为低电平期间，数据线上的高电平或低电平状态才允许变化。

![img](https://img2020.cnblogs.com/blog/1943620/202111/1943620-20211119154522863-1978594337.png)

**5.数据的传送：**

在I2C总线上传送的每一位数据都有一个时钟脉冲相对应（或同步控制），即在SCL串行时钟的配合下，在SDA上逐位地串行传送每一位数据。数据位的传输是边沿触发。

![img](https://img2020.cnblogs.com/blog/1943620/202111/1943620-20211119154533438-1174691264.png)

### **三、工作过程**

总线上的所有通信都是由主控器引发的。在一次通信中，主控器与被控器总是在扮演着两种不同的角色。

**1.主设备向从设备发送数据**

主设备发送起始位，这会通知总线上的所有设备传输开始了，接下来主机发送设备地址，与这一地址匹配的slave将继续这一传输过程，而其它slave将会忽略接下来的传输并等待下一次传输的开始。

主设备寻址到从设备后，发送它所要读取或写入的从设备的内部寄存器地址； 之后，发送数据。数据发送完毕后，发送停止位。

写入过程如下：

1. 发送起始位
2. 发送从设备的地址和读/写选择位；释放总线，等到EEPROM拉低总线进行应答；如果EEPROM接收成功，则进行应答；若没有握手成功或者发送的数据错误时EEPROM不产生应答，此时要求重发或者终止。
3. 发送想要写入的内部寄存器地址；EEPROM对其发出应答
4. 发送数据
5. 发送停止位

EEPROM收到停止信号后，进入到一个内部的写入周期，大概需要10ms，此间任何操作都不会被EEPROM响应

![img](https://img2020.cnblogs.com/blog/1943620/202111/1943620-20211119154545582-458821597.png)

**2.主控器读取数据的过程**

读的过程比较复杂，在从slave读出数据前，你必须先要告诉它哪个内部寄存器是你想要读取的，因此必须先对其进行写入：

1. 发送起始位；
2. 发送slave地址+write bit set；
3. 发送内部寄存器地址；
4. 重新发送起始位，即restart；
5. 重新发送slave地址+read bit set；
6. 读取数据
7. 发送停止位

主机接收器在接收到最后一个字节后，也不会发出ACK信号。于是，从机发送器释放 SDA线，以允许主机发出P信号结束传输。

![img](https://img2020.cnblogs.com/blog/1943620/202111/1943620-20211119154556618-176659016.png)

**3、数据传送格式**

每一个字节必须保证是8位长度。数据传送时，先传送最高位（MSB），每一个被传送的字节后面都必须跟随一位应答位（即一帧共有9位）。

由于某种原因从机不对主机寻址信号应答时（如从机正在进行实时性的处理工作而无法接收总线上的数据），它必须将数据线置于高电平，而由主机产生一个终止信号以结束总线的数据传送。

如果从机对主机进行了应答，但在数据传送一段时间后无法继续接收更多的数据时，从机可以通过对无法接收的第一个数据字节的“非应答”通知主机，主机则应发出终止信号以结束数据的继续传送。

当主机接收数据时，它收到最后一个数据字节后，必须向从机发出一个结束传送的信号。这个信号是由对从机的“非应答”来实现的。然后，从机释放SDA线，以允许主机产生终止信号。

**4、总线的寻址**

I2C总线协议有明确的规定：采用7位的寻址字节（寻址字节是起始信号后的第一个字节）。

（1）寻址字节的位定义

D7～D1位组成从机的地址。D0位是数据传送方向位，为“0”时表示主机向从机写数据，为“1”时表示主机由从机读数据。

![img](https://img2020.cnblogs.com/blog/1943620/202111/1943620-20211119154609194-1022219369.png)

主机发送地址时，总线上的每个从机都将这7位地址码与自己的地址进行比较，如果相同，则认为自己正被主机寻址，根据R/位将自己确定为发送器或接收器。

从机的地址由固定部分和可编程部分组成。在一个系统中可能希望接入多个相同的从机，从机地址中可编程部分决定了可接入总线该类器件的最大数目。

如一个从机的7位寻址位有4位是固定位，3位是可编程位，这时仅能寻址8个同样的器件，即可以有8个同样的器件接入到该I2C总线系统中。

（2）寻址字节中的特殊地址

固定地址编号0000和1111已被保留作为特殊用途。

![img](https://img2020.cnblogs.com/blog/1943620/202111/1943620-20211119154620663-712911954.png)

起始信号后的第一字节的8位为“0000 0000”时，称为通用呼叫地址。通用呼叫地址的用意在第二字节中加以说明。格式为：

![img](https://img2020.cnblogs.com/blog/1943620/202111/1943620-20211119154631711-548685008.png)

第二字节为 06H（0110）时，所有能响应通用呼叫地址的从机器件复位，并由硬件装入从机地址的可编程部分。能响应命令的从机器件复位时不拉低SDA和SCL线，以免堵塞总线。

第二字节为 04H（0100）时，所有能响应通用呼叫地址并通过硬件来定义其可编程地址的从机器件将锁定地址中的可编程位，但不进行复位。

如果第二字节的方向位B为“1”，则这两个字节命令称为硬件通用呼叫命令。 在这第二字节的高7位说明自己的地址。接在总线上的智能器件，如单片机或其他微处理器能识别这个地址，并与之传送数据。硬件主器件作为从机使用时，也用这个地址作为从机地址。格式为：

在系统中另一种选择可能是系统复位时硬件主机器件工作在从机接收器方式，这时由系统中的主机先告诉硬件主机器件数据应送往的从机器件地址，当硬件主机器件要发送数据时就可以直接向指定从机器件发送数据了。

（3）起始字节

起始字节是提供给没有I2C总线接口的单片机查询I2C总线时使用的特殊字节。

不具备I2C总线接口的单片机，则必须通过软件不断地检测总线，以便及时地响应总线的请求。

单片机的速度与硬件接口器件的速度就出现了较大的差别，为此，I2C总线上的数据传送要由一个较长的起始过程加以引导。

引导过程由起始信号、起始字节、应答位、重复起始信号（Sr）组成。

请求访问总线的主机发出起始信号后，发送起始字节（0000 0001），另一个单片机可以用一个比较低的速率采样SDA线，直到检测到起始字节中的7个“0”中的一个为止。

在检测到SDA线上的高电平后，单片机就可以用较高的采样速率，以便寻找作为同步信号使用的第二个起始信号Sr。

在起始信号后的应答时钟脉冲仅仅是为了和总线所使用的格式一致，并不要求器件在这个脉冲期间作应答。

 
